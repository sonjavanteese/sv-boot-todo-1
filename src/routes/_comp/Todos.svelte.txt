<script>
  import { _user, supabase } from "../../lib/data";
  import Todo from "../../lib/components/Todo.svelte";
  import { onMount } from "svelte";

  let todos = [];
  let newTask = "";

  onMount(async () => {
    await getAllTodos();
  });

  const getAllTodos = async () => {
    try {
      let { data, error } = await supabase.from("todos").select("*");
      todos = data;
    } catch (err) {
      console.log(err);
    }
  };

  const addNewTodo = async () => {
    try {
      const { data, error } = await supabase
        .from("todos")
        .insert([{ task: newTask, user_id: $_user.id }]);
      await getAllTodos();
      newTask = "";
    } catch (err) {
      console.log(err);
    }
  };

  const updateTodo = async (todo) => {
    try {
      const { data, error } = await supabase
        .from("todos")
        .update({ task: todo.task, isComplete: todo.isComplete })
        .eq("id", todo.id);
      await getAllTodos();
    } catch (err) {
      console.log(err);
    }
  };
  const deleteTodo = async (todo) => {
    try {
      const { data, error } = await supabase
        .from("todos")
        .delete()
        .eq("id", todo.id);
      await getAllTodos();
    } catch (err) {
      console.log(err);
    }
  };

  const handleKeyPress = (event) => {
    if (event.key === "Enter" && newTask !== "") {
      addNewTodo();
    }
  };

  const logOut = async () => {
    let { error } = await supabase.auth.signOut();
    console.log("LOGOUT");
  };

  $: console.log($_user);
</script>

<section class="container">

  <div class="input-group my-3">
    <input
      bind:value={newTask}
      type="text"
      class="form-control"
      placeholder="add..."
    />
    <button
      on:click={() => addNewTodo()}
      class="btn btn-outline-secondary"
      type="button"
      id="button-addon2">Add Task</button
    >
  </div>
  <div class="list-group-x">
    {#each todos as todo}
      <Todo {todo} {updateTodo} {deleteTodo} />
      <!--   x <br />-->
    {:else}
      <p>No todos found</p>
    {/each}
  </div>

  <hr />
  <article class="my-3 p-3 bg-white rounded shadow-sm">
    <h6 class="border-bottom pb-2 mb-0">Pages</h6>
    <div class="d-flex text-muted pt-3" data-pg-collapsed>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
        width="32"
        height="32"
        data-pg-collapsed
        class="bd-placeholder-img flex-shrink-0 me-3 rounded"
      >
        <g>
          <path fill="none" d="M0 0h24v24H0z" />
          <path d="M10 10.111V1l11 6v14H3V7z" />
        </g>
      </svg>
      <div class="pb-3 mb-0 small lh-sm border-bottom w-100" data-pg-collapsed>
        <div class="d-flex justify-content-between" data-pg-collapsed>
          <strong class="fs-5 text-gray-dark">Full Name</strong><a
            href="#"
            class="text-decoration-none">Follow</a
          >
        </div>
        <span class="d-block fst-italic">@username</span>
      </div>
    </div>
    <div class="d-flex text-muted pt-3" data-pg-collapsed>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
        width="32"
        height="32"
        data-pg-collapsed
        class="bd-placeholder-img flex-shrink-0 me-3 rounded"
      >
        <g>
          <path fill="none" d="M0 0h24v24H0z" />
          <path
            d="M20 22H4a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1zM8 7v2h8V7H8zm0 4v2h8v-2H8zm0 4v2h5v-2H8z"
          />
        </g>
      </svg>
      <div class="pb-3 mb-0 small lh-sm border-bottom w-100">
        <div class="d-flex justify-content-between">
          <strong class="fs-5 text-gray-dark">Full Name</strong><a
            href="#"
            class="text-decoration-none">Follow</a
          >
        </div>
        <span class="d-block fst-italic">@username</span>
      </div>
    </div>
    <div class="d-flex text-muted pt-3">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
        width="32"
        height="32"
        data-pg-collapsed
        class="bd-placeholder-img flex-shrink-0 me-3 rounded"
      >
        <g>
          <path fill="none" d="M0 0h24v24H0z" />
          <path
            d="M8.686 4l2.607-2.607a1 1 0 0 1 1.414 0L15.314 4H19a1 1 0 0 1 1 1v3.686l2.607 2.607a1 1 0 0 1 0 1.414L20 15.314V19a1 1 0 0 1-1 1h-3.686l-2.607 2.607a1 1 0 0 1-1.414 0L8.686 20H5a1 1 0 0 1-1-1v-3.686l-2.607-2.607a1 1 0 0 1 0-1.414L4 8.686V5a1 1 0 0 1 1-1h3.686zM12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"
          />
        </g>
      </svg>
      <div class="pb-3 mb-0 small lh-sm border-bottom w-100">
        <div class="d-flex justify-content-between">
          <strong class="fs-5 text-gray-dark">Full Name</strong><a
            href="#"
            class="text-decoration-none">Follow</a
          >
        </div>
        <span class="d-block fst-italic">@username</span>
      </div>
    </div>
    <small class="d-block text-end mt-3"
      ><button href="#" class="btn btn-dark">All Pages</button></small
    >
  </article>

  
  <!-- 
  <div class="add-todo">
    <input type="text" bind:value={newTask} />
    <button on:click={() => addNewTodo()}>Add Task</button>
  </div> -->

<!-- 
  {#if $_user.email}
    <p on:click={logOut} class="switch">Logout</p>
  {/if} -->
</section>
<svelte:window on:keypress={handleKeyPress} />

<style>

  .add-todo {
    display: flex;
    margin-bottom: 0.5em;
  }

  :global(.switch) {
    color: lightskyblue;
    cursor: pointer;
  }

  :global(.switch:hover) {
    text-decoration: underline;
  }
</style>
